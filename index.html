<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Results App</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl mb-4">Results Entry</h1>

  <form id="entryForm" class="bg-white p-4 rounded shadow mb-6 space-y-4">
    <div class="grid grid-cols-2 gap-4">
      <input name="name" placeholder="Name" required class="input-base" />
      <input name="roll" placeholder="Roll" required class="input-base"/>
      <!-- Score inputs: -->
      <template id="score-template">
        <div class="col-span-1">
          <label class="block text-sm text-gray-700"></label>
          <input type="text" name="" placeholder="e.g. 45+22" class="input-base"/>
        </div>
      </template>
    </div>
    <!-- Add all required score fields -->
    <div id="scoresGrid" class="grid grid-cols-2 lg:grid-cols-3 gap-4"></div>
    <div class="flex space-x-2">
      <button type="submit" class="btn-blue">Save</button>
      <button type="button" id="resetBtn" class="btn-gray">Reset</button>
      <button type="button" id="searchBtn" class="btn-yellow">Search by Roll</button>
    </div>
  </form>

  <div class="flex justify-between mb-4">
    <h2 class="text-xl">Records</h2>
    <button id="printBtn" class="btn-green">Print</button>
  </div>
  <div class="overflow-auto bg-white p-4 rounded shadow">
    <table class="min-w-full text-sm" id="dataTbl">
      <thead class="bg-gray-200">
        <tr>
          <th>Roll</th><th>Name</th><th>Total</th><th>Pass/Fail</th>
          <!-- Other headers -->
          <th>Grade</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
  const APP_URL = 'https://script.google.com/macros/s/AKfycbxXFdI_hygAkD91oODjQA10CbJzvSty6jN75NkR9bM203u0DHxvN2wHOl0F7_Ye0r0G/exec';
  const fields = [
    'kuran_tajvid','akaid_fikah','hadis','arabic1','arabic2','gmath',
    'english1','english2','bengali1','bengali2','ishistory_physics',
    'phedu_bio','chemistry_ict','ag_hmath'
  ];
  const form = document.getElementById('entryForm');
  const grid = document.getElementById('scoresGrid');
  const tbody = document.querySelector('#dataTbl tbody');

  // helper
  function sn(s){ return s.split('+').reduce((a,p)=>a+parseFloat(p||0),0); }
  function gradePoint(x){
    if (x>=80) return [5.00,'A+'];
    if (x>=70) return [4.00,'A'];
    if (x>=60) return [3.50,'Aâˆ’'];
    if (x>=50) return [3.00,'B'];
    if (x>=40) return [2.00,'C'];
    if (x>=33) return [1.00,'D'];
    return [0.00,'F'];
  }

  // build inputs
  fields.forEach(fn=>{
    const tpl = document.getElementById('score-template');
    const el = tpl.content.cloneNode(true);
    const lbl = el.querySelector('label');
    const inp = el.querySelector('input');
    lbl.textContent = fn.replace(/_/g,' ').toUpperCase();
    inp.name = fn;
    grid.appendChild(el);
  });

  async function fetchAll(){
    const res = await fetch(APP_URL);
    return res.json();
  }
  function renderRows(data){
    tbody.innerHTML='';
    data.forEach(r=>{
      const tr = document.createElement('tr');
      const total = fields.reduce((a,f)=>a + parseFloat(r[f]||0),0);
      const [pt,gr] = gradePoint(total/fields.length);
      const pf = pt>0 ? 'Pass' : 'Fail';
      ['roll','name'].concat(['total','pass_fail'],fields,['cgpa','grade'])
        .forEach(col=>{
          const td = tr.appendChild(document.createElement('td'));
          if(col==='total') td.textContent = total.toFixed(2);
          else if(col==='pass_fail') td.textContent = pf;
          else if(col==='cgpa') td.textContent = (total/fields.length/20).toFixed(2);
          else if(col==='grade') td.textContent = gr;
          else td.textContent = r[col] || '';
        });
      // actions
      const act = tr.appendChild(document.createElement('td'));
      ['Edit','Delete'].forEach(txt=>{
        const b = document.createElement('button');
        b.textContent=txt;
        b.className = txt==='Edit'?'btn-yellow':'btn-red';
        b.onclick = ()=>{
          if(txt==='Edit'){
            Object.entries(r).forEach(([k,v])=>{
              if(form.elements[k]) form.elements[k].value = v;
            });
          } else {
            if(confirm('Delete record?'))
              fetch(APP_URL+'?action=delete',{ method:'POST', body: JSON.stringify({roll:r.roll})})
              .then(()=> load());
          }
        };
        act.appendChild(b);
      });
      tbody.appendChild(tr);
    });
  }

  async function load(){
    const all = await fetchAll();
    renderRows(all);
  }

  form.onsubmit = async e=>{
    e.preventDefault();
    const fd = new FormData(form);
    const payload = {action:'create'};
    for(const k of [...form.elements].filter(i=>i.name)) {
      payload[k.name] = k.value;
    }
    await fetch(APP_URL+'?action=create',{
      method:'POST',
      body: JSON.stringify(payload)
    });
    form.reset();
    load();
  };

  document.getElementById('resetBtn').onclick = () => form.reset();

  document.getElementById('searchBtn').onclick = async () => {
    const roll = form.elements.roll.value.trim();
    if(!roll) return alert('Enter roll');
    const all = await fetchAll();
    const rec = all.find(r=>r.roll===roll);
    if(rec){
      Object.entries(rec).forEach(([k,v])=>{
        if(form.elements[k]) form.elements[k].value = v;
      });
    } else alert('Not found');
  };

  document.getElementById('printBtn').onclick = ()=> {
    const tbl = document.querySelector('#dataTbl');
    const clone = tbl.cloneNode(true);
    Array.from(clone.querySelectorAll('th:last-child,td:last-child')).forEach(n => n.remove());
    const w = window.open();
    w.document.write('<html><head><title>Print</title>');
    w.document.write('<style>table{width:100%;border-collapse:collapse}td,th{border:1px solid #000;padding:4px}</style>');
    w.document.write('</head><body>' + clone.outerHTML + '</body></html>');
    w.print();
    w.close();
  };

  load();
  </script>

  <style>
  .input-base{width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;}
  .btn-blue{background:#3b82f6;color:#fff;padding:0.5rem 1rem;border:none;border-radius:4px;}
  .btn-gray{background:#9ca3af;color:#fff;padding:0.5rem;}
  .btn-yellow{background:#f59e0b;color:#fff;padding:0.25rem 0.5rem;margin-right:4px;}
  .btn-red{background:#ef4444;color:#fff;padding:0.25rem 0.5rem;margin-left:4px;}
  .btn-green{background:#10b981;color:#fff;padding:0.5rem 1rem;}
  </style>
</body>
</html>
