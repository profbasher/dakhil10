<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Result Web App</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Enter Student Result</h1>
    <form id="studentForm" class="grid grid-cols-2 gap-4">
      <div><label>Roll *</label><input name="roll" required class="w-full border p-2"/></div>
      <div><label>Name *</label><input name="name" required class="w-full border p-2"/></div>
      <!-- Numeric fields -->
      <script>
        const fields = [
          'kuran_tajvid','akaid_fikah','hadis','gmath','chemistry_ict',
          'arabic1','arabic2','english1','english2',
          'bengali1','bengali2','ishistory_physics',
          'phedu_bio','ag_hmath'
        ];
        fields.forEach(f => {
          document.write(`<div><label>${f.replace(/_/g,' ').toUpperCase()}</label><input name="${f}" type="text" class="w-full border p-2"/></div>`);
        });
      </script>
      <div class="col-span-2 flex space-x-4 mt-4">
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button>
        <button type="button" id="searchBtn" class="bg-yellow-500 text-white px-4 py-2 rounded">Search</button>
        <button type="button" id="printBtn" class="bg-green-500 text-white px-4 py-2 rounded">Print</button>
      </div>
    </form>

    <h2 class="text-xl font-bold mt-8 mb-4">Results</h2>
    <div class="overflow-auto max-h-96">
      <table class="min-w-full bg-white" id="resultsTable">
        <thead><tr>
          <th class="p-2 border">Roll</th><th class="p-2 border">Name</th><th class="p-2 border">Total</th><th class="p-2 border">PF</th>
          <script>
            ['kuran_tajvid','akaid_fikah','hadis','arabic1','arabic2',
            'english1','english2','bengali1','bengali2','ishistory_physics',
            'gmath','phedu_bio','chemistry_ict','ag_hmath','cgpa','grade'
            ].forEach(c => document.write(`<th class="p-2 border">${c.replace(/_/g,' ').toUpperCase()}</th>`));
          </script>
          <th class="p-2 border">Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDTkB7JgOebvxXrQhLm7OPPLtgBnaxv7erkErbdkAVUgZfkHoXpThnEkymc3OORQj8/exec';
    const form = document.getElementById('studentForm');
    const tbody = document.querySelector('#resultsTable tbody');
    const fields = ['kuran_tajvid','akaid_fikah','hadis','gmath','chemistry_ict','arabic1','arabic2','english1','english2','bengali1','bengali2','ishistory_physics','phedu_bio','ag_hmath'];

    function calcTotals(data) {
      let total = 0, countPass = true;
      fields.forEach(f => {
        const v = parseFloat(data[f]) || 0;
        total += v;
        if (v < 33) countPass = false;
      });
      const cgpa = total / (fields.length * 20);
      let gradePoint=0, grade='F';
      if(cgpa>=4.0){gradePoint=5;grade='A+';}
      else if(cgpa>=3.5){gradePoint=4;grade='A';}
      else if(cgpa>=3.0){gradePoint=3.5;grade='A-';}
      else if(cgpa>=2.5){gradePoint=3;grade='B';}
      else if(cgpa>=2.0){gradePoint=2;grade='C';}
      else if(cgpa>=1.0){gradePoint=1;grade='D';}
      data.total = total.toFixed(2);
      data.pass_fail = countPass ? 'Pass' : 'Fail';
      data.cgpa = gradePoint.toFixed(2);
      data.grade = grade;
    }

    function refresh(dataList=[]) {
      tbody.innerHTML = '';
      dataList.forEach(d => {
        calcTotals(d);
        const row = document.createElement('tr');
        ['roll','name','total','pass_fail',...fields,'cgpa','grade'].forEach(c => {
          const td = document.createElement('td');
          td.textContent = d[c];
          td.className = 'p-2 border text-center';
          row.appendChild(td);
        });
        const act = document.createElement('td'); act.className='p-2 border';
        const btnE = document.createElement('button');
        btnE.textContent='Edit'; btnE.className='bg-yellow-300 px-2 rounded mr-2';
        btnE.onclick = () => {
          Object.keys(d).forEach(k => {
            if(form[k]) form[k].value = d[k];
          });
        };
        const btnD = document.createElement('button');
        btnD.textContent='Delete'; btnD.className='bg-red-400 px-2 rounded';
        btnD.onclick = () => {
          if(confirm('Delete this?')) {
            fetch(`${SCRIPT_URL}?action=delete&roll=${d.roll}`).then(r=>r.json()).then(() => loadAll());
          }
        };
        act.appendChild(btnE);
        act.appendChild(btnD);
        row.appendChild(act);
        tbody.appendChild(row);
      });
    }

    function loadAll() {
      fetch(`${SCRIPT_URL}?action=list`).then(r=>r.json()).then(d=>refresh(d));
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const data = {};
      new FormData(form).forEach((v,k)=>data[k]=v.trim());
      calcTotals(data);
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({...data, action: 'upsert'})
      }).then(r=>r.json()).then(resp => {
        alert(resp.status);
        loadAll();
        form.reset();
      });
    });

    document.getElementById('searchBtn').onclick = () => {
      const roll = form.roll.value.trim();
      if(!roll) return alert('Enter roll to search');
      fetch(`${SCRIPT_URL}?action=get&roll=${roll}`).then(r=>r.json()).then(d => {
        if(d.roll) { refresh([d]); }
        else alert('Not found');
      });
    };
    document.getElementById('printBtn').onclick = () => {
      const hide = document.querySelectorAll('td:last-child, th:last-child');
      hide.forEach(el => el.style.display='none');
      window.print();
      hide.forEach(el => el.style.display='table-cell');
    };
    loadAll();
  </script>
</body>
</html>
