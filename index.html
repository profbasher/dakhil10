<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Result Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-3xl mb-4">Result Manager</h1>
    <!-- Form -->
    <form id="form" class="bg-white p-4 rounded shadow mb-6 grid grid-cols-2 gap-4">
      <!-- Name + Roll -->
      <div>
        <label>Name</label><input name="name" required class="input"/>
      </div>
      <div>
        <label>Roll</label><input name="roll" required class="input"/>
      </div>
      <!-- Scores -->
      <template id="f">
        <div>
          <label></label><input class="input" name=""></input>
        </div>
      </template>
    </form>

    <div class="mb-4">
      <label>Search:</label><input id="search" class="input"/>
      <button id="print" class="btn bg-green-500 text-white ml-2">Print</button>
    </div>

    <table id="tbl" class="min-w-full bg-white shadow rounded">
      <thead class="bg-gray-200"><tr>
        ["roll","name","total","pass_fail","kuran_tajvid","akaid_fikah","hadis","arabic1","arabic2","gmath","english1","english2","bengali1","bengali2","ishistory_physics","phedu_bio","chemistry_ict","ag_hmath","cgpa","grade"].forEach(c=>document.write(`<th class="p-2 border">${c.replace('_','/')}</th>`));
        document.write(`<th class="p-2 border">Actions</th>`);
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const FIELDS=[
      "kuran_tajvid","akaid_fikah","hadis","arabic1","arabic2",
      "gmath","english1","english2","bengali1","bengali2",
      "ishistory_physics","phedu_bio","chemistry_ict","ag_hmath"
    ];

    const form = document.getElementById('form');
    const tmpl = document.getElementById('f');
    FIELDS.forEach(f=>{
      const d = tmpl.content.cloneNode(true);
      d.querySelector('label').innerText = f.replace('_','/');
      d.querySelector('input').name = f;
      form.appendChild(d);
    });

    const API_URL = 'https://script.google.com/macros/s/AKfycbxwYIuwkb67D9Z6UjIkpHv1ZKF01jGxhbn9XiENWipIIiOUmLMf3uSV_UTah92mZ4Gz/exec';

    async function fetchAll(){
      const d = await fetch(API_URL).then(r=>r.json());
      window.data = d;
      display(d);
    }

    function calcTotals(obj){
      let sum = 0, fail=false;
      FIELDS.forEach(f=>{
        const v = parseFloat(obj[f])||0;
        sum += v;
        if(v<33) fail=true;
      });
      obj.total = sum;
      obj.pass_fail = fail?'Fail':'Pass';
      obj.cgpa = (sum / (FIELDS.length*100) *5).toFixed(2);
      const p = (sum / (FIELDS.length*100))*100;
      const G=[80,70,60,50,40,33,0].find((t,i)=>p>=t);
      const map={'80':'A+','70':'A','60':'Aâˆ’','50':'B','40':'C','33':'D','0':'F'};
      obj.grade = map[G];
    }

    function display(arr){
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = '';
      arr.filter(r=> {
        const q = document.getElementById('search').value.toLowerCase();
        return !q || r.name.toLowerCase().includes(q)|| r.roll.includes(q);
      }).forEach(r=>{
        const tr = document.createElement('tr');
        [...FIELDS,'total','pass_fail','cgpa','grade','roll','name'].forEach(c=>{
          const td = document.createElement('td');
          td.innerText = r[c];
          td.className='p-1 border text-center';
          tr.appendChild(td);
        });
        const act = document.createElement('td');
        act.className='p-1 border text-center';
        ['Edit','Delete'].forEach(a=>{
          const b = document.createElement('button');
          b.innerText = a;
          b.className='btn m-1 bg-blue-500 text-white';
          b.onclick = ()=>{
            if(a=='Delete'){
              if(!confirm('Delete?')) return;
              post('delete',r).then(fetchAll);
            } else {
              Object.keys(r).forEach(k=>{
                if(form[k]) form[k].value = r[k];
              });
            }
          };
          act.appendChild(b);
        });
        tr.appendChild(act);
        tb.appendChild(tr);
      });
    }

    async function post(action,data){
      calcTotals(data);
      const res = await fetch(API_URL, {
        method:'POST',
        body: JSON.stringify({action,data})
      }).then(r=>r.json());
      if(res.status!='ok') alert(res.message);
      return res;
    }

    form.onsubmit = e=>{
      e.preventDefault();
      const d = Object.fromEntries(new FormData(form));
      post('create',d).then(fetchAll);
    };

    document.getElementById('search').oninput=()=>display(window.data);
    document.getElementById('print').onclick=()=> window.print();

    fetchAll();
  </script>

  <style>
    .input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: .25rem;
    }
    .btn { padding: 0.5rem 1rem; border-radius: .25rem; }
  </style>
</body>
</html>
